# StakeTogether

## Link to repo: https://github.com/levackt/stakepool

## Link to google doc equivalent: https://docs.google.com/document/d/1ZuHIVCmqAl5QPZFknp27N5uqwO7HB3iXwEUS5R6RXuI/edit?usp=sharing

## What is StakeTogether on Secret Network?

### Introduction
SecretPoolTogether creates a no-loss lottery game based on staking yield provided by Secret Network. Instead of delegating to individual validators, users who participate in the lottery pool their delegation in a smart contract. At the end of each period, staking rewards generated by pooled assets go to one of the participants. This is a weighted lottery where higher contributions have greater chance of winning. We are exploring delegations and rewards to be paid in secretSCRT to increase the anonymity set of secretSCRT

#### Secret contract components
The components of SecretPoolTogether include a raffle contract and a staking contract. This section is supposed to highlight one potential implementation of SecretPoolTogether. Final implementation may differentiate from what’s detailed below, as long as it achieves the same functionality. 

#### Raffle contract
Raffle contract needs to:
* Generate a random number to determine the winner  
* Access state of the staking contract to determine weights corresponding to different users. I am thinking that we can take the deposits in a time-stamped manner (block number) and create an array of cumulative deposits. Then multiply the RNG outcome with the total deposits at snapshot (height of the Array) to determine who wins. See example here.

Raffle contract will be called (by the deployer of the contract) to generate a random number and determine the winning address based on the weights received from the staking contract. If possible, we should build this as a call function with the staking contract.

Improvement area: The raffle contract can be called in a decentralized way (nice to have - not in MVP, if hard)

#### Staking contract
Staking contract is the contract to which players in SecretPoolTogether send secretSCRT. Staking contract then converts any secretSCRT to SCRT and delegates to a validator. At any time, the available balance in the staking contract represents the rewards to be distributed to the winner as all users deposits are directly sent to the validator. 

Staking contract passes the weights to the raffle contract at time 0 (after the last winner is determined) in v0. Depositors after the cut-off time still earn rewards however those depositors will only be eligible for the next period’s raffle. 

Once the raffle contract passes the winning address to the staking contract, the staking contract converts the rewards secertSCRT and distributes funds to the winning address.

##### Open point for discussion: 
* secretSCRT participation is much better narrative for the network compared to SCRT participation and should be prioritized
* Staking contract accepts secretSCRT, records state in secretSCRT to determine weights for the raffle contract, converts and stakes SCRT. After the raffle, the rewards are then turned into secretSCRT and sent to the winner. The goal is to create increased demand & liquidity around secertSCRT
* Does the deposit contract that accepts secretSCRT have a viewing key? Can we see the deposits into the viewing contract

##### Improvement area:
* In v0 if Bob stakes after the i th reward distribution, Bob is not included in i+1st reward distribution. Current design allows quick deployment without the need to account for differences in contribution to reward pool at different times. I.e. Alice staking 1 SCRT on Day 1 vs. Bob staking 1 SCRT on Day 5 contributes differently to the pool
* Add contributor addresses ineligible for the rewards (?) 

### Validator
In v0, we opt in for 1 validator to run pool together. Potential future work can include permissionless validator contract that allows users to choose validator of choice when participating in SecretPoolTogether. This would also need to account for different validator fees while calculating user weights


#### UI - WIP
Take PoolTogether’s UI as an inspiration and integrate secret.js

### Detailed user flow
(1) Alice enters next pool

(2) Entering a pool is the same activity as depositing to the staking contract. Alice chooses “Enter in the raffle” when she’s in the GUI. If Alice doesn’t have any secretSCRT, Alice needs to acquire secretSCRT. This is the landing page for the app. Things to change from the main page are:

(3) Get tickets -> Enter SecretPoolTogether

(4) Get secretSCRT -> we can send the user to Keplr app

(5) View pool -> as is, we can show the amount of staked in the validator + rewards

(6) This weeks prize value -> show expected SCRT reward * price_SCRT or we can also just add the existing reward pool *price_SCRT

(7) Withdraw / exit raffle -> we should add a button below “Get tickets”

(8) We will need to make a note that even though the next raffle is in time t, Alice will be eligible for rewards in t+1 weeks. We can edit the footnote.

(9) Timer is on the UI counting down

<img width="309" alt="Timer" src="https://user-images.githubusercontent.com/25411371/120375716-b4665400-c2e0-11eb-85f6-85eca5ff924c.PNG">

(10) Alice withdraws from the pool


### Alice clicks on withdraw on the main page. 

  Does Alice lose her chance to win if she exits right before the raffle is completed? Design choice on what’s easier, if there’s an easy way to account for Alice’s contribution to the raffle until she withdraws let’s add her to the raffle. If not Alice can forego her chance to win. If the latter is the case, we should create a notification pop-up that Alice agrees to (nice to have)

### Alice winnings, all time
* Alice clicks on accounts tab to see:
* Alice’s winnings all time
* Odds of winning the current raffle (%)
* number of raffles Alice participated in

Alice’s stake (view balance)

### Alice winnings, all time

Alice clicks on accounts tab to see:

View current prize - landing page app.secretpooltogether.com ??

View odds of winning
Show this in Alice profile

<img width="313" alt="Overview" src="https://user-images.githubusercontent.com/25411371/120376388-73bb0a80-c2e1-11eb-83ae-ee80a78e9548.PNG">

Landing page -> view pool -> odd of winning calculated if Alice is actually staking, otherwise n/a%

View balances

Alice views balance in her profile, we can show this as secretSCRT or SCRT. I don’t think we need to add a new token as a result of staking. Maybe v2

### Admin - Detailed user flow

##### Choose a validator

Don’t have a strong opinion, don’t need a GUI for this, can be manually added when the contract is being deployed.

##### Lock contract

What do we mean by this

##### Unlock contract

What do we mean by this

##### Unbond all

CLI - if this needs to happen we update the app page with a big disclaimer saying this is happening

##### Register other contracts

Out of scope until we have secretAMM and other yield generating products. In the future if other assets can be converted to secretSCRT and stake or other assets are creating yield, we can think about adding them

Sponsor - Detailed user flow

Out of scope for v0

### Future work

##### Referral rewards
Look into allocation a portion of rewards to a pool that’s then subject to another lottery among referral points. If Alice converts 5 users, who actually stake), Alice gets 5 points and Bob 2. Alice’s chance of winning referral rewards is 5/7 that week.

### Governance token
Maybe a governance token is minted to decide parameters like platform fees. These fees can be pooled to fund future development of secretPoolTogether

### New tokens / contracts to be addded
Out of scope until we have secretAMM and other yield generating products. In the future if other assets can be converted to secretSCRT and stake or other assets are creating yield, we can think about adding them

